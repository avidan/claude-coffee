<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coffee Brewing Optimizer</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        coffee: {
                            50: '#fef7ed',
                            100: '#feefd5',
                            200: '#fcdcaa',
                            300: '#f9c275',
                            400: '#f59e3d',
                            500: '#f28224',
                            600: '#e3681a',
                            700: '#bc4f18',
                            800: '#973f1c',
                            900: '#7a351b'
                        }
                    },
                    backgroundImage: {
                        'coffee-gradient': 'linear-gradient(135deg, #f59e3d 0%, #e3681a 50%, #bc4f18 100%)',
                        'amber-gradient': 'linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%)'
                    }
                }
            }
        }
    </script>
    <style>
        .coffee-bg {
            background: linear-gradient(135deg, #f59e3d 0%, #e3681a 50%, #bc4f18 100%);
        }
        .amber-bg {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .camera-overlay {
            position: relative;
            overflow: hidden;
        }
        .camera-overlay::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80%;
            height: 80%;
            transform: translate(-50%, -50%);
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            pointer-events: none;
        }
        .recipe-card {
            transition: all 0.3s ease;
        }
        .recipe-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
    </style>
</head>
<body class="min-h-screen coffee-bg">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;
        const { Camera, Upload, Download, Share2, Droplets, Coffee, Thermometer, Clock, MapPin, Award, Zap, ChevronRight, X, Check, AlertCircle } = lucide;

        // Coffee brewing optimization algorithms
        const BREWING_PROFILES = {
            Ethiopia: {
                baseTemp: 205,
                grindSize: 'medium-fine',
                bloomTime: 45,
                totalTime: 4.5,
                waterRatio: 16,
                steps: [
                    { temp: 205, time: '0:00-0:45', action: 'Bloom with 2x coffee weight in water' },
                    { temp: 200, time: '0:45-2:30', action: 'Slow circular pour to 60% total water' },
                    { temp: 195, time: '2:30-4:30', action: 'Final pour and drawdown' }
                ]
            },
            Colombia: {
                baseTemp: 200,
                grindSize: 'medium',
                bloomTime: 30,
                totalTime: 5,
                waterRatio: 17,
                steps: [
                    { temp: 200, time: '0:00-0:30', action: 'Bloom with gentle pour' },
                    { temp: 196, time: '0:30-2:45', action: 'Steady pour in center' },
                    { temp: 192, time: '2:45-5:00', action: 'Final extraction phase' }
                ]
            },
            Brazil: {
                baseTemp: 195,
                grindSize: 'medium-coarse',
                bloomTime: 30,
                totalTime: 5.5,
                waterRatio: 16.5,
                steps: [
                    { temp: 195, time: '0:00-0:30', action: 'Short bloom' },
                    { temp: 190, time: '0:30-3:00', action: 'Continuous pour' },
                    { temp: 185, time: '3:00-5:30', action: 'Slow finish' }
                ]
            },
            Kenya: {
                baseTemp: 208,
                grindSize: 'medium-fine',
                bloomTime: 60,
                totalTime: 4,
                waterRatio: 15.5,
                steps: [
                    { temp: 208, time: '0:00-1:00', action: 'Extended bloom for brightness' },
                    { temp: 203, time: '1:00-2:20', action: 'Aggressive pour for extraction' },
                    { temp: 198, time: '2:20-4:00', action: 'Controlled finish' }
                ]
            },
            Guatemala: {
                baseTemp: 202,
                grindSize: 'medium',
                bloomTime: 45,
                totalTime: 4.75,
                waterRatio: 16.2,
                steps: [
                    { temp: 202, time: '0:00-0:45', action: 'Standard bloom' },
                    { temp: 198, time: '0:45-2:40', action: 'Spiral pour technique' },
                    { temp: 194, time: '2:40-4:45', action: 'Gentle completion' }
                ]
            }
        };

        const WATER_TREATMENTS = {
            pure: { tempAdjust: 0, timeAdjust: 0, description: 'Pure water - no adjustments needed' },
            apax: { tempAdjust: -3, timeAdjust: 15, description: 'Apax drops - reduce temp 3Â°F, extend time 15s' }
        };

        function CoffeeBrewingApp() {
            const [currentView, setCurrentView] = useState('camera');
            const [capturedImage, setCapturedImage] = useState(null);
            const [coffeeData, setCoffeeData] = useState(null);
            const [recipe, setRecipe] = useState(null);
            const [waterTreatment, setWaterTreatment] = useState('pure');
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [apiKey, setApiKey] = useState('');
            const [error, setError] = useState('');
            
            const fileInputRef = useRef(null);
            const videoRef = useRef(null);
            const canvasRef = useRef(null);

            const handleImageCapture = async (file) => {
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const imageDataUrl = e.target.result;
                    setCapturedImage(imageDataUrl);
                    setCurrentView('analyze');
                };
                reader.readAsDataURL(file);
            };

            const analyzeImage = async () => {
                if (!capturedImage || !apiKey) {
                    setError('Please provide an API key and capture an image');
                    return;
                }

                setIsAnalyzing(true);
                setError('');

                try {
                    const base64Data = capturedImage.split(',')[1];
                    const mimeType = capturedImage.split(',')[0].split(':')[1].split(';')[0];

                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': apiKey
                        },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-20250514',
                            max_tokens: 1000,
                            messages: [{
                                role: 'user',
                                content: [
                                    {
                                        type: 'image',
                                        source: {
                                            type: 'base64',
                                            media_type: mimeType,
                                            data: base64Data
                                        }
                                    },
                                    {
                                        type: 'text',
                                        text: `Analyze this coffee bag image and extract the following information in JSON format:
                                        {
                                            "country": "country of origin",
                                            "region": "specific region/farm if visible",
                                            "roaster": "roaster name",
                                            "coffeeName": "specific coffee name/blend",
                                            "roastLevel": "light/medium/dark",
                                            "processing": "washed/natural/honey/etc",
                                            "variety": "bean variety if visible",
                                            "flavorNotes": ["flavor", "notes", "array"],
                                            "elevation": "elevation if visible",
                                            "confidence": "high/medium/low based on image clarity"
                                        }
                                        Only return the JSON, no other text.`
                                    }
                                ]
                            }]
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API request failed: ${response.status}`);
                    }

                    const data = await response.json();
                    const analysisResult = JSON.parse(data.content[0].text);
                    setCoffeeData(analysisResult);
                    generateRecipe(analysisResult);
                    setCurrentView('recipe');
                } catch (error) {
                    console.error('Analysis error:', error);
                    setError('Failed to analyze image. Please check your API key and try again.');
                } finally {
                    setIsAnalyzing(false);
                }
            };

            const generateRecipe = (coffeeInfo) => {
                const country = coffeeInfo.country || 'Colombia';
                const profile = BREWING_PROFILES[country] || BREWING_PROFILES.Colombia;
                const treatment = WATER_TREATMENTS[waterTreatment];

                const adjustedProfile = {
                    ...profile,
                    steps: profile.steps.map(step => ({
                        ...step,
                        temp: step.temp + treatment.tempAdjust,
                        time: adjustAdjustTime(step.time, treatment.timeAdjust)
                    }))
                };

                const fellowRecipe = {
                    id: Date.now(),
                    name: `${coffeeInfo.coffeeName || 'Custom Coffee'} - ${country}`,
                    coffee: coffeeInfo,
                    profile: adjustedProfile,
                    waterTreatment: waterTreatment,
                    createdAt: new Date().toISOString()
                };

                setRecipe(fellowRecipe);
            };

            const adjustAdjustTime = (timeRange, adjustment) => {
                if (adjustment === 0) return timeRange;
                
                const [start, end] = timeRange.split('-');
                const [endMin, endSec] = end.split(':').map(Number);
                const totalSeconds = endMin * 60 + endSec + adjustment;
                const newMin = Math.floor(totalSeconds / 60);
                const newSec = totalSeconds % 60;
                
                return `${start}-${newMin}:${newSec.toString().padStart(2, '0')}`;
            };

            const downloadRecipe = () => {
                if (!recipe) return;

                const fellowAidenRecipe = {
                    version: "1.0",
                    name: recipe.name,
                    description: `Optimized recipe for ${recipe.coffee.country} coffee with ${waterTreatment} water treatment`,
                    coffeeAmount: "22g",
                    waterAmount: `${Math.round(22 * recipe.profile.waterRatio)}g`,
                    grindSize: recipe.profile.grindSize,
                    steps: recipe.profile.steps.map((step, index) => ({
                        step: index + 1,
                        temperature: `${step.temp}Â°F`,
                        duration: step.time.split('-')[1],
                        instruction: step.action,
                        pourPattern: index === 0 ? "center" : "spiral"
                    })),
                    metadata: {
                        origin: recipe.coffee.country,
                        roaster: recipe.coffee.roaster,
                        roastLevel: recipe.coffee.roastLevel,
                        flavorNotes: recipe.coffee.flavorNotes,
                        waterTreatment: waterTreatment,
                        createdBy: "Coffee Brewing Optimizer",
                        createdAt: recipe.createdAt
                    }
                };

                const blob = new Blob([JSON.stringify(fellowAidenRecipe, null, 2)], {
                    type: 'application/json'
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${recipe.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_fellow_aiden.json`;
                a.click();
                URL.revokeObjectURL(url);
            };

            const shareRecipe = async () => {
                if (!recipe) return;

                const shareText = `â˜• ${recipe.name}\n\nðŸŒ Origin: ${recipe.coffee.country}\nðŸ”¥ Roast: ${recipe.coffee.roastLevel}\n\nðŸ“ Recipe:\n${recipe.profile.steps.map((step, i) => `${i + 1}. ${step.temp}Â°F - ${step.time}\n   ${step.action}`).join('\n')}\n\nðŸ’§ Water: ${waterTreatment === 'pure' ? 'Pure water' : 'With Apax drops'}\n\nCreated with Coffee Brewing Optimizer`;

                if (navigator.share) {
                    try {
                        await navigator.share({
                            title: recipe.name,
                            text: shareText
                        });
                    } catch (error) {
                        console.log('Share cancelled');
                    }
                } else {
                    navigator.clipboard.writeText(shareText);
                    alert('Recipe copied to clipboard!');
                }
            };

            const CameraView = () => (
                <div className="min-h-screen flex flex-col">
                    <div className="flex-1 flex flex-col items-center justify-center p-6">
                        <div className="text-center mb-8">
                            <Coffee className="w-16 h-16 text-white mx-auto mb-4" />
                            <h1 className="text-3xl font-bold text-white mb-2">Coffee Brewing Optimizer</h1>
                            <p className="text-white/80">Capture your coffee bag for optimized brewing recipes</p>
                        </div>

                        {!apiKey && (
                            <div className="w-full max-w-md mb-6">
                                <input
                                    type="password"
                                    placeholder="Enter Claude API Key"
                                    value={apiKey}
                                    onChange={(e) => setApiKey(e.target.value)}
                                    className="w-full p-3 rounded-lg bg-white/10 text-white placeholder-white/60 border border-white/20 focus:outline-none focus:ring-2 focus:ring-white/30"
                                />
                            </div>
                        )}

                        <div className="camera-overlay w-full max-w-sm h-64 bg-white/10 rounded-xl mb-6 flex items-center justify-center">
                            <div className="text-center">
                                <Camera className="w-12 h-12 text-white/60 mx-auto mb-2" />
                                <p className="text-white/60 text-sm">Position coffee bag here</p>
                            </div>
                        </div>

                        <div className="space-y-3 w-full max-w-sm">
                            <button
                                onClick={() => fileInputRef.current?.click()}
                                disabled={!apiKey}
                                className="w-full bg-white text-coffee-600 py-4 rounded-xl font-semibold flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                <Camera className="w-5 h-5" />
                                <span>Take Photo</span>
                            </button>

                            <button
                                onClick={() => fileInputRef.current?.click()}
                                disabled={!apiKey}
                                className="w-full glass-effect text-white py-4 rounded-xl font-semibold flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                <Upload className="w-5 h-5" />
                                <span>Choose from Library</span>
                            </button>
                        </div>

                        <input
                            ref={fileInputRef}
                            type="file"
                            accept="image/*"
                            capture="environment"
                            onChange={(e) => handleImageCapture(e.target.files[0])}
                            className="hidden"
                        />
                    </div>
                </div>
            );

            const AnalyzeView = () => (
                <div className="min-h-screen flex flex-col p-6">
                    <div className="flex items-center mb-6">
                        <button
                            onClick={() => setCurrentView('camera')}
                            className="text-white p-2"
                        >
                            <X className="w-6 h-6" />
                        </button>
                        <h2 className="text-xl font-bold text-white ml-4">Analyze Coffee</h2>
                    </div>

                    <div className="flex-1 flex flex-col items-center">
                        {capturedImage && (
                            <div className="w-full max-w-md mb-6">
                                <img 
                                    src={capturedImage} 
                                    alt="Coffee bag" 
                                    className="w-full h-64 object-cover rounded-xl"
                                />
                            </div>
                        )}

                        <div className="w-full max-w-md mb-6">
                            <label className="block text-white mb-2 font-medium">Water Treatment</label>
                            <div className="grid grid-cols-2 gap-3">
                                <button
                                    onClick={() => setWaterTreatment('pure')}
                                    className={`p-3 rounded-lg flex items-center space-x-2 ${
                                        waterTreatment === 'pure' 
                                            ? 'bg-white text-coffee-600' 
                                            : 'bg-white/10 text-white border border-white/20'
                                    }`}
                                >
                                    <Droplets className="w-4 h-4" />
                                    <span className="text-sm">Pure Water</span>
                                </button>
                                <button
                                    onClick={() => setWaterTreatment('apax')}
                                    className={`p-3 rounded-lg flex items-center space-x-2 ${
                                        waterTreatment === 'apax' 
                                            ? 'bg-white text-coffee-600' 
                                            : 'bg-white/10 text-white border border-white/20'
                                    }`}
                                >
                                    <Zap className="w-4 h-4" />
                                    <span className="text-sm">Apax Drops</span>
                                </button>
                            </div>
                        </div>

                        {error && (
                            <div className="w-full max-w-md mb-6 p-4 bg-red-500/20 border border-red-500/30 rounded-lg">
                                <div className="flex items-center space-x-2 text-red-200">
                                    <AlertCircle className="w-5 h-5" />
                                    <span className="text-sm">{error}</span>
                                </div>
                            </div>
                        )}

                        <button
                            onClick={analyzeImage}
                            disabled={isAnalyzing || !apiKey}
                            className="w-full max-w-md bg-white text-coffee-600 py-4 rounded-xl font-semibold flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            {isAnalyzing ? (
                                <>
                                    <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-coffee-600"></div>
                                    <span>Analyzing...</span>
                                </>
                            ) : (
                                <>
                                    <Zap className="w-5 h-5" />
                                    <span>Analyze & Generate Recipe</span>
                                </>
                            )}
                        </button>
                    </div>
                </div>
            );

            const RecipeView = () => (
                <div className="min-h-screen flex flex-col p-6">
                    <div className="flex items-center justify-between mb-6">
                        <button
                            onClick={() => setCurrentView('camera')}
                            className="text-white p-2"
                        >
                            <X className="w-6 h-6" />
                        </button>
                        <h2 className="text-xl font-bold text-white">Optimized Recipe</h2>
                        <div></div>
                    </div>

                    {recipe && (
                        <div className="flex-1">
                            <div className="bg-white/10 backdrop-blur-sm rounded-xl p-6 mb-6">
                                <h3 className="text-2xl font-bold text-white mb-4">{recipe.name}</h3>
                                
                                <div className="grid grid-cols-2 gap-4 mb-6">
                                    <div className="flex items-center space-x-2 text-white/80">
                                        <MapPin className="w-4 h-4" />
                                        <span className="text-sm">{recipe.coffee.country}</span>
                                    </div>
                                    <div className="flex items-center space-x-2 text-white/80">
                                        <Award className="w-4 h-4" />
                                        <span className="text-sm">{recipe.coffee.roastLevel}</span>
                                    </div>
                                    <div className="flex items-center space-x-2 text-white/80">
                                        <Thermometer className="w-4 h-4" />
                                        <span className="text-sm">{recipe.profile.baseTemp}Â°F</span>
                                    </div>
                                    <div className="flex items-center space-x-2 text-white/80">
                                        <Clock className="w-4 h-4" />
                                        <span className="text-sm">{recipe.profile.totalTime} min</span>
                                    </div>
                                </div>

                                {recipe.coffee.flavorNotes && recipe.coffee.flavorNotes.length > 0 && (
                                    <div className="mb-6">
                                        <h4 className="text-white font-semibold mb-2">Flavor Notes</h4>
                                        <div className="flex flex-wrap gap-2">
                                            {recipe.coffee.flavorNotes.map((note, index) => (
                                                <span key={index} className="bg-white/20 text-white px-3 py-1 rounded-full text-sm">
                                                    {note}
                                                </span>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div className="bg-white/10 backdrop-blur-sm rounded-xl p-6 mb-6">
                                <h4 className="text-white font-semibold mb-4 flex items-center space-x-2">
                                    <Coffee className="w-5 h-5" />
                                    <span>Brewing Steps</span>
                                </h4>
                                
                                <div className="space-y-4">
                                    {recipe.profile.steps.map((step, index) => (
                                        <div key={index} className="flex items-start space-x-4">
                                            <div className="step-number">{index + 1}</div>
                                            <div className="flex-1">
                                                <div className="flex items-center space-x-4 mb-1">
                                                    <span className="text-white font-medium">{step.temp}Â°F</span>
                                                    <span className="text-white/80 text-sm">{step.time}</span>
                                                </div>
                                                <p className="text-white/90 text-sm">{step.action}</p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-3">
                                <button
                                    onClick={downloadRecipe}
                                    className="bg-white text-coffee-600 py-4 rounded-xl font-semibold flex items-center justify-center space-x-2"
                                >
                                    <Download className="w-5 h-5" />
                                    <span>Download</span>
                                </button>

                                <button
                                    onClick={shareRecipe}
                                    className="glass-effect text-white py-4 rounded-xl font-semibold flex items-center justify-center space-x-2"
                                >
                                    <Share2 className="w-5 h-5" />
                                    <span>Share</span>
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );

            return (
                <div className="min-h-screen coffee-bg">
                    {currentView === 'camera' && <CameraView />}
                    {currentView === 'analyze' && <AnalyzeView />}
                    {currentView === 'recipe' && <RecipeView />}
                </div>
            );
        }

        ReactDOM.render(<CoffeeBrewingApp />, document.getElementById('root'));
    </script>
</body>
</html>