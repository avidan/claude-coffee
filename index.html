<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coffee Brewing Optimizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .coffee-bg {
            background: linear-gradient(135deg, #f59e3d 0%, #e3681a 50%, #bc4f18 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .camera-overlay {
            position: relative;
            overflow: hidden;
        }
        .camera-overlay::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80%;
            height: 80%;
            transform: translate(-50%, -50%);
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            pointer-events: none;
        }
        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        .loading-spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 2px solid #fff;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .btn {
            padding: 16px 24px;
            border-radius: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .btn-primary {
            background: white;
            color: #ea580c;
        }
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="min-h-screen coffee-bg">
    <div id="root">
        <div class="min-h-screen flex items-center justify-center">
            <div class="text-center text-white">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p>Loading Coffee Brewing Optimizer...</p>
            </div>
        </div>
    </div>

    <!-- Icons as SVG -->
    <div id="icons" style="display: none;">
        <svg id="camera-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path>
            <circle cx="12" cy="13" r="3"></circle>
        </svg>
        <svg id="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7,10 12,15 17,10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        <svg id="coffee-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 8h1a4 4 0 0 1 0 8h-1"></path>
            <path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path>
            <line x1="6" y1="1" x2="6" y2="4"></line>
            <line x1="10" y1="1" x2="10" y2="4"></line>
            <line x1="14" y1="1" x2="14" y2="4"></line>
        </svg>
        <svg id="droplets-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.84-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z"></path>
            <path d="M12.56 6.6A10.97 10.97 0 0 0 14 3.02c.5 2.5 2.26 4.89 4.56 6.96a7.93 7.93 0 0 1 2.3 3.73 3.85 3.85 0 0 1-.68 3.37 3.94 3.94 0 0 1-3.2 1.42c-.22 0-.45 0-.67-.05"></path>
        </svg>
        <svg id="zap-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="13,2 3,14 12,14 11,22 21,10 12,10 13,2"></polygon>
        </svg>
        <svg id="download-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-15"></path>
            <polyline points="7,10 12,15 17,10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        <svg id="share-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="18" cy="5" r="3"></circle>
            <circle cx="6" cy="12" r="3"></circle>
            <circle cx="18" cy="19" r="3"></circle>
            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
        </svg>
        <svg id="x-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
    </div>

    <script>
        console.log('Script starting...');

        // Coffee brewing profiles
        const BREWING_PROFILES = {
            Ethiopia: {
                baseTemp: 205,
                grindSize: 'medium-fine',
                bloomTime: 45,
                totalTime: 4.5,
                waterRatio: 16,
                steps: [
                    { temp: 205, time: '0:00-0:45', action: 'Bloom with 2x coffee weight in water' },
                    { temp: 200, time: '0:45-2:30', action: 'Slow circular pour to 60% total water' },
                    { temp: 195, time: '2:30-4:30', action: 'Final pour and drawdown' }
                ]
            },
            Colombia: {
                baseTemp: 200,
                grindSize: 'medium',
                bloomTime: 30,
                totalTime: 5,
                waterRatio: 17,
                steps: [
                    { temp: 200, time: '0:00-0:30', action: 'Bloom with gentle pour' },
                    { temp: 196, time: '0:30-2:45', action: 'Steady pour in center' },
                    { temp: 192, time: '2:45-5:00', action: 'Final extraction phase' }
                ]
            }
        };

        const WATER_TREATMENTS = {
            pure: { tempAdjust: 0, timeAdjust: 0, description: 'Pure water - no adjustments needed' },
            apax: { tempAdjust: -3, timeAdjust: 15, description: 'Apax drops - reduce temp 3Â°F, extend time 15s' }
        };

        // App state
        let state = {
            currentView: 'camera',
            capturedImage: null,
            coffeeData: null,
            recipe: null,
            waterTreatment: 'pure',
            isAnalyzing: false,
            error: ''
        };

        // Backend API URL
        const API_BASE_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3001' 
            : 'https://coffee-optimizer-1754982003-72200d7a1813.herokuapp.com';

        function createIcon(iconId, className = 'w-5 h-5') {
            const template = document.getElementById(iconId);
            const icon = template.cloneNode(true);
            icon.style.display = 'inline-block';
            icon.className = className;
            icon.removeAttribute('id');
            return icon;
        }

        function setState(newState) {
            state = { ...state, ...newState };
            render();
        }

        function handleImageCapture(file) {
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                setState({
                    capturedImage: e.target.result,
                    currentView: 'analyze'
                });
            };
            reader.readAsDataURL(file);
        }

        async function analyzeImage() {
            if (!state.capturedImage) {
                setState({ error: 'Please capture an image first' });
                return;
            }

            setState({ isAnalyzing: true, error: '' });

            try {
                const base64Data = state.capturedImage.split(',')[1];
                const mimeType = state.capturedImage.split(',')[0].split(':')[1].split(';')[0];

                const response = await fetch(`${API_BASE_URL}/api/analyze-coffee`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        imageData: base64Data,
                        mimeType: mimeType
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    throw new Error(errorData.error || `Request failed: ${response.status}`);
                }

                const data = await response.json();
                
                if (!data.success || !data.data) {
                    throw new Error('Invalid response from analysis service');
                }

                const analysisResult = data.data;
                
                generateRecipe(analysisResult);
                setState({
                    coffeeData: analysisResult,
                    currentView: 'recipe',
                    isAnalyzing: false
                });
            } catch (error) {
                console.error('Analysis error:', error);
                setState({
                    error: `Failed to analyze image: ${error.message}`,
                    isAnalyzing: false
                });
            }
        }

        function generateRecipe(coffeeInfo) {
            const country = coffeeInfo.country || 'Colombia';
            const profile = BREWING_PROFILES[country] || BREWING_PROFILES.Colombia;
            const treatment = WATER_TREATMENTS[state.waterTreatment];

            const adjustedProfile = {
                ...profile,
                steps: profile.steps.map(step => ({
                    ...step,
                    temp: step.temp + treatment.tempAdjust
                }))
            };

            const fellowRecipe = {
                id: Date.now(),
                name: `${coffeeInfo.coffeeName || 'Custom Coffee'} - ${country}`,
                coffee: coffeeInfo,
                profile: adjustedProfile,
                waterTreatment: state.waterTreatment,
                createdAt: new Date().toISOString()
            };

            setState({ recipe: fellowRecipe });
        }

        function downloadRecipe() {
            if (!state.recipe) return;

            const fellowAidenRecipe = {
                version: "1.0",
                name: state.recipe.name,
                description: `Optimized recipe for ${state.recipe.coffee.country} coffee with ${state.waterTreatment} water treatment`,
                coffeeAmount: "22g",
                waterAmount: `${Math.round(22 * state.recipe.profile.waterRatio)}g`,
                grindSize: state.recipe.profile.grindSize,
                steps: state.recipe.profile.steps.map((step, index) => ({
                    step: index + 1,
                    temperature: `${step.temp}Â°F`,
                    duration: step.time.split('-')[1],
                    instruction: step.action,
                    pourPattern: index === 0 ? "center" : "spiral"
                }))
            };

            const blob = new Blob([JSON.stringify(fellowAidenRecipe, null, 2)], {
                type: 'application/json'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${state.recipe.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_fellow_aiden.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function render() {
            const root = document.getElementById('root');
            
            if (state.currentView === 'camera') {
                root.innerHTML = `
                    <div class="min-h-screen flex flex-col">
                        <div class="flex-1 flex flex-col items-center justify-center p-6">
                            <div class="text-center mb-8">
                                <div class="w-16 h-16 mx-auto mb-4 text-white">${createIcon('coffee-icon', 'w-16 h-16').outerHTML}</div>
                                <h1 class="text-3xl font-bold text-white mb-2">Coffee Brewing Optimizer</h1>
                                <p class="text-white text-opacity-80">Capture your coffee bag for optimized brewing recipes</p>
                            </div>
                            
                            
                            <div class="camera-overlay w-full max-w-sm h-64 bg-white bg-opacity-10 rounded-xl mb-6 flex items-center justify-center">
                                <div class="text-center">
                                    ${createIcon('camera-icon', 'w-12 h-12 text-white text-opacity-60').outerHTML}
                                    <p class="text-white text-opacity-60 text-sm mt-2">Position coffee bag here</p>
                                </div>
                            </div>
                            
                            <div class="w-full max-w-sm">
                                <button 
                                    id="photoBtn" 
                                    class="btn btn-primary w-full"
                                >
                                    ${createIcon('camera-icon').outerHTML}
                                    <span id="photoBtnText">Add Coffee Photo</span>
                                </button>
                            </div>
                            
                            <input type="file" id="fileInput" accept="image/*" style="display: none;" />
                        </div>
                    </div>
                `;
                
                // Add event listeners
                const fileInput = document.getElementById('fileInput');
                const photoBtn = document.getElementById('photoBtn');
                
                if (fileInput && photoBtn) {
                    // Detect if device has camera capability
                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    const hasCamera = navigator.mediaDevices && navigator.mediaDevices.getUserMedia;
                    
                    // Set input attributes based on device capabilities
                    if (isMobile && hasCamera) {
                        fileInput.setAttribute('capture', 'environment');
                        document.getElementById('photoBtnText').textContent = 'Take or Choose Photo';
                    } else {
                        fileInput.removeAttribute('capture');
                        document.getElementById('photoBtnText').textContent = 'Choose Photo';
                    }
                    
                    fileInput.addEventListener('change', (e) => {
                        if (e.target.files[0]) {
                            handleImageCapture(e.target.files[0]);
                        }
                    });
                    
                    photoBtn.addEventListener('click', () => {
                        fileInput.click();
                    });
                }
            }
            
            else if (state.currentView === 'analyze') {
                root.innerHTML = `
                    <div class="min-h-screen flex flex-col p-6">
                        <div class="flex items-center mb-6">
                            <button id="backBtn" class="text-white p-2">
                                ${createIcon('x-icon', 'w-6 h-6').outerHTML}
                            </button>
                            <h2 class="text-xl font-bold text-white ml-4">Analyze Coffee</h2>
                        </div>
                        
                        <div class="flex-1 flex flex-col items-center">
                            ${state.capturedImage ? `
                                <div class="w-full max-w-md mb-6">
                                    <img src="${state.capturedImage}" alt="Coffee bag" class="w-full h-64 object-cover rounded-xl" />
                                </div>
                            ` : ''}
                            
                            <div class="w-full max-w-md mb-6">
                                <label class="block text-white mb-2 font-medium">Water Treatment</label>
                                <div class="grid grid-cols-2 gap-3">
                                    <button id="pureWaterBtn" class="p-3 rounded-lg flex items-center space-x-2 ${state.waterTreatment === 'pure' ? 'bg-white text-orange-600' : 'bg-white bg-opacity-10 text-white border border-white border-opacity-20'}">
                                        ${createIcon('droplets-icon', 'w-4 h-4').outerHTML}
                                        <span class="text-sm">Pure Water</span>
                                    </button>
                                    <button id="apaxBtn" class="p-3 rounded-lg flex items-center space-x-2 ${state.waterTreatment === 'apax' ? 'bg-white text-orange-600' : 'bg-white bg-opacity-10 text-white border border-white border-opacity-20'}">
                                        ${createIcon('zap-icon', 'w-4 h-4').outerHTML}
                                        <span class="text-sm">Apax Drops</span>
                                    </button>
                                </div>
                            </div>
                            
                            ${state.error ? `
                                <div class="w-full max-w-md mb-6 p-4 bg-red-500 bg-opacity-20 border border-red-500 border-opacity-30 rounded-lg">
                                    <div class="flex items-center space-x-2 text-red-200">
                                        <span class="text-sm">${state.error}</span>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <button 
                                id="analyzeBtn" 
                                class="btn btn-primary w-full max-w-md ${state.isAnalyzing ? 'opacity-50 cursor-not-allowed' : ''}"
                                ${state.isAnalyzing ? 'disabled' : ''}
                            >
                                ${state.isAnalyzing ? '<div class="loading-spinner border-orange-600"></div>' : createIcon('zap-icon').outerHTML}
                                <span>${state.isAnalyzing ? 'Analyzing...' : 'Analyze & Generate Recipe'}</span>
                            </button>
                        </div>
                    </div>
                `;
                
                // Add event listeners
                document.getElementById('backBtn').addEventListener('click', () => {
                    setState({ currentView: 'camera' });
                });
                
                document.getElementById('pureWaterBtn').addEventListener('click', () => {
                    setState({ waterTreatment: 'pure' });
                });
                
                document.getElementById('apaxBtn').addEventListener('click', () => {
                    setState({ waterTreatment: 'apax' });
                });
                
                document.getElementById('analyzeBtn').addEventListener('click', () => {
                    if (!state.isAnalyzing) {
                        analyzeImage();
                    }
                });
            }
            
            else if (state.currentView === 'recipe' && state.recipe) {
                root.innerHTML = `
                    <div class="min-h-screen flex flex-col p-6">
                        <div class="flex items-center justify-between mb-6">
                            <button id="backBtn" class="text-white p-2">
                                ${createIcon('x-icon', 'w-6 h-6').outerHTML}
                            </button>
                            <h2 class="text-xl font-bold text-white">Optimized Recipe</h2>
                            <div></div>
                        </div>
                        
                        <div class="flex-1">
                            <div class="bg-white bg-opacity-10 backdrop-blur-sm rounded-xl p-6 mb-6">
                                <h3 class="text-2xl font-bold text-white mb-4">${state.recipe.name}</h3>
                                
                                <div class="grid grid-cols-2 gap-4 mb-6">
                                    <div class="flex items-center space-x-2 text-white text-opacity-80">
                                        <span class="text-sm">ð ${state.recipe.coffee.country}</span>
                                    </div>
                                    <div class="flex items-center space-x-2 text-white text-opacity-80">
                                        <span class="text-sm">ð¥ ${state.recipe.coffee.roastLevel}</span>
                                    </div>
                                    <div class="flex items-center space-x-2 text-white text-opacity-80">
                                        <span class="text-sm">ð¡ï¸ ${state.recipe.profile.baseTemp}Â°F</span>
                                    </div>
                                    <div class="flex items-center space-x-2 text-white text-opacity-80">
                                        <span class="text-sm">â±ï¸ ${state.recipe.profile.totalTime} min</span>
                                    </div>
                                </div>
                                
                                ${state.recipe.coffee.flavorNotes && state.recipe.coffee.flavorNotes.length > 0 ? `
                                    <div class="mb-6">
                                        <h4 class="text-white font-semibold mb-2">Flavor Notes</h4>
                                        <div class="flex flex-wrap gap-2">
                                            ${state.recipe.coffee.flavorNotes.map(note => `
                                                <span class="bg-white bg-opacity-20 text-white px-3 py-1 rounded-full text-sm">${note}</span>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div class="bg-white bg-opacity-10 backdrop-blur-sm rounded-xl p-6 mb-6">
                                <h4 class="text-white font-semibold mb-4 flex items-center space-x-2">
                                    ${createIcon('coffee-icon').outerHTML}
                                    <span>Brewing Steps</span>
                                </h4>
                                
                                <div class="space-y-4">
                                    ${state.recipe.profile.steps.map((step, index) => `
                                        <div class="flex items-start space-x-4">
                                            <div class="step-number">${index + 1}</div>
                                            <div class="flex-1">
                                                <div class="flex items-center space-x-4 mb-1">
                                                    <span class="text-white font-medium">${step.temp}Â°F</span>
                                                    <span class="text-white text-opacity-80 text-sm">${step.time}</span>
                                                </div>
                                                <p class="text-white text-opacity-90 text-sm">${step.action}</p>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <button id="downloadBtn" class="btn btn-primary">
                                    ${createIcon('download-icon').outerHTML}
                                    <span>Download</span>
                                </button>
                                
                                <button id="shareBtn" class="btn btn-secondary">
                                    ${createIcon('share-icon').outerHTML}
                                    <span>Share</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add event listeners
                document.getElementById('backBtn').addEventListener('click', () => {
                    setState({ currentView: 'camera' });
                });
                
                document.getElementById('downloadBtn').addEventListener('click', downloadRecipe);
                
                document.getElementById('shareBtn').addEventListener('click', async () => {
                    const shareText = `â ${state.recipe.name}\n\nð Origin: ${state.recipe.coffee.country}\nð¥ Roast: ${state.recipe.coffee.roastLevel}\n\nð Recipe:\n${state.recipe.profile.steps.map((step, i) => `${i + 1}. ${step.temp}Â°F - ${step.time}\n   ${step.action}`).join('\n')}\n\nð§ Water: ${state.waterTreatment === 'pure' ? 'Pure water' : 'With Apax drops'}\n\nCreated with Coffee Brewing Optimizer`;
                    
                    if (navigator.share) {
                        try {
                            await navigator.share({
                                title: state.recipe.name,
                                text: shareText
                            });
                        } catch (error) {
                            console.log('Share cancelled');
                        }
                    } else {
                        navigator.clipboard.writeText(shareText);
                        alert('Recipe copied to clipboard!');
                    }
                });
            }
        }

        console.log('Initial render...');
        render();
        console.log('App initialized');
    </script>
</body>
</html>